{% extends "./layout.html" %}
{% block head %}
<section class="hero is-info">
    <div class="hero-body">
        <div class="container">
            <h1 class="title">Information on: {{domain.domain}}</h1>
            <h2 class="subtitle">Status: <span id="status">{{domain.status}}</span>
      </h2>
            <input type="hidden" id="url" value="{{domain.url}}">
            <!--h1 class=title">Simple check running for Domain: {{domain}}</h1-->
            <table class="table">
                <thead>
                    <tr>
                        <th><abbr title="Domain">Domain</abbr></th>
                        <th><abbr title="Name from Impressum">Name</abbr></th>
                        <th><abbr title="Title from home/index directory">Title</abbr></th>
                        <th><abbr title="Zip Code">ZIP</abbr></th>
                        <th><abbr title="Duration">Duration</abbr></th>
                        <th><abbr title="Last Update">Updated At</abbr></th>
                        <!--      <th><abbr title="Externals">External Urls Found</abbr></th> -->
                        <!--      <th><abbr title="last_Updated">Last Updated At</abbr></th> -->
                        <!--     <th><abbr title="Duration of last search">Duration</abbr></th> -->
                        <th><abbr title="Local Urls Crawled">Locals</abbr></th>
                        <th><abbr title="External Urls Found">Filtered Externals</abbr></th>
                        <th><abbr title="Options">Options</abbr></th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td id="domain">{{domain.domain}}</td>
                        <td>{{domain.name}}</td>
                        <td>{{domain.title}}</td>
                        <td>{{domain.zip}}</td>
                        <td>{{domain.duration}}</td>
                        <td>{{domain.last_update}}</td>
                        <!--td>{{domain.externals.count}}</td-->
                        <!--td>{ { d omain.updated_at}}</td>
      <td>
        {% csrf_token %}
        <button id="refresh" class="button is-primary" type="submit">Refresh</button>
      </td-->
                        <td>{{domain.locals.count}}</td>
                        <td>{{domain.filtered_externals.count}}</td>
                        <td><a class="button is-primary" href="{% url 'refresh' domain.domain%}">Refresh</a> start search for externals</td>
                    </tr>
                </tbody>
            </table>
            <div class="content">
                <button id="infoscan" class="button is-primary is-inverted">InfoScan</button>
                <a class="button is-primary is-inverted" href="/TODO">Filters</a>
                <a class="button is-primary is-inverted" href="/TODO">Graph</a>
            </div>
        </div>
    </div>
</section>
{% endblock %}
{% block content%}
<div class="container">
    <table id="externals" class="display">
        <thead>
            <tr>
                <th>#</th>
                <th>External Domains</th>
                <th>External Urls</th>
                <th>ZIP</th>
                <th>Name</th>
                <th>Status</th>
                <th>Options</th>
            </tr>
        </thead>
        <tbody>
            {% for external in domain.filtered_externals %}
            <tr>
                <th id="id">{{ forloop.counter }}</th>
                <td id="external_domain">{{external.external_domain}}</td>
                <td id="external_url"><a href="{{ external.url }}">{{external.url|truncatechars_html:50}}</a></td>
                <td id="zip_id_{{ forloop.counter }}">{{external.info.zip}}</td>
                <td id="name_id_{{ forloop.counter }}">
                    {% if external.info.name != 'dummy' %}
                    {{external.info.name}}
                    {% elif external.info.title != 'None!' %}
                    {{external.info.title}}
                    {% else %}
                    Nothing found.
                    {% endif %}
                </td>
                <td id="status_id_{{ forloop.counter }}">---</td>
                <td><a class="button is-danger is-outlined" href="{% url 'filter' src_domain=domain.domain external_domain=external.external_domain %}">Add to Filter</a>
                    <button class="button is-success is-outlined" onclick="startScraping('infospider','{{external.external_domain}}','{{ external.url }}','#status_id_{{ forloop.counter }}', 'refresh')">Run InfoScan</button></td>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    <table id="locals" class="display">
        <thead>
            <tr>
                <th>Locals Urls</th>
                <th>Options</th>
            </tr>
        </thead>
        <tbody>
            {% for local in domain.locals.all %}
            <tr>
                <td>{{local.url|truncatechars_html:120}}</td>
                <td>Options</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% endblock %}
{% block javascript %}
<script>
function startScraping(spider, domain, url, display_id, job) {
    var start_spider = {
        domain: domain,
        url: url,
        name: spider,
        keywords: $("#domain").text(),
        display_id: display_id,
        job: job
    }
    //simple spider checking only Impressum, Title, Keywords
    $.post("/api/post/", start_spider,
        function(data) {
            //alert(data['task_id']);
            if (data.info) {
                $(start_spider.display_id).html('zip: ' + data.info.zip +
                    'name: ' + new_data.data.info.name + '" readonly></div>');
                return;
            }
            var interval = 1500;
            (function doUpdate() {
                $.get("/api/get/", { task_id: data['task_id'], domain: start_spider.domain },
                        function(new_data) {
                            if (new_data.status)
                                $(start_spider.display_id).html('<div class="control is-loading">' +
                                    '<input class="input" type="text" value="' + new_data.status +
                                    '" readonly></div>');
                            else {
                                console.log(new_data);
                                $(start_spider.display_id).html(new_data.data.status);
                            }
                        })
                    .done(function() {
                        var status = $(start_spider.display_id).text()
                        if (status == 'finished' && start_spider.job == 'None') {
                            location.reload(true);
                        } else if (status == 'finished' && start_spider.job == 'refresh') {
                            console.log('finished domain: ' + start_spider.domain);
                        } else if (status.includes('zip')) {
                            console.log('finished domain: ' + start_spider.domain);
                        } else {
                            console.log('not finished... ');
                            setTimeout(doUpdate, interval);
                        }
                    });
            })();
        });
}
$(document).ready(function() {
    $('#externals').DataTable({
        "order": [
            [1, 'desc']
        ]
    });
    $('#locals').DataTable();
    var isFinished = $("#status").text() == 'finished';
    if (isFinished)
        return;
    var url = $("#url").val();
    var domain = $("#domain").text();
    return startScraping('botspider', domain, url, '#status', 'None');
});
$("#refresh").click(function() {
    var url = $("#url").val();
    var domain = $("#domain").text();
    return startScraping('botspider', domain, url, '#status', 'None');
});
$("#infoscan").click(function() {
    $("#externals > tbody > tr").each(function() {
        domain = $(this).find("#external_domain").text();
        url = $(this).find("#external_url").text();
        display_id = '#result_id_' + $(this).find("#id").text();
        return startScraping('infospider', domain, url, display_id, 'None');
    });
});
$(".run_infoscan").click(function() {
    console.log($(this).parent().parent());
    /*$("#externals > tbody > tr").each(function() {
        domain = $(this).find("#external_domain").text();
        url = $(this).find("#external_url").text();
        display_id = '#result_id_' + $(this).find("#id").text();
        return startScraping('infospider', domain, url, display_id);
    });*/
});
</script>
{% endblock %}