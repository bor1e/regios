{% extends "./layout.html" %}
{% block content %}
<section class="hero is-info">
  <div class="hero-body">
    <div class="container">
      <h1 class="title">
      Domains to crawl:
<span id="to_crawl">{{ to_crawl }}</span>
      </h1>
<h2 class="subtitle">Crawling Level #<span id="level">{{ level }}</span> now...
</h2>
    </div>
  </div>
</section>
<table class="table is-striped">
  <thead>
    <tr>
      <th>#</th>
      <th><abbr title="External Domain">Domain</abbr></th>
      <th><abbr title="Status">Status</abbr></th>
    </tr>
  </thead>
   <tbody>
    {% for key, value in externals.items %}
      <tr>
        <th>{{ forloop.counter }}</th>
        <td id="key_domain">{{ key }}</td>
        <td id="key_info">-
          <input type="hidden" id="url_{{ forloop.counter }}" value="{{value}}">
        </td>
      </tr>
    {% endfor %}
  </tbody>
</table>
</div>
</section>

{% endblock %}
{% block javascript %}
<script>
    var counter = $("#to_crawl").text()
    var level = $("#level").text()
    $("tbody tr").each(function () {
     domain = $(this).find("#key_domain").text();
     url = $(this).find("input").val();
     var self = this
     $.post("/api/crawl/", {domain: domain, url: url, level: level, function: 'debug'}, function(data) {
        console.log(data); // check out how data is structured
        $(self).find('#key_info').html(data.data);
      });
    });
    /*
    $("#update").click(function(){
      //alert($("#domain").val())
        $.post("/api/crawl/", {domain: domain, function: 'debug'},function(data) {
          console.log(data); // check out how data is structured
          });
        return false;
    });
    function startCrawling(id) {
      //$("#table-name td").each(function () {
        var ex_dmn = $("#ex_dmn_"+id).text();
        var ex_url = $("#ex_url_"+id).text();
        $.post("/api/crawl/", {domain: ex_dmn, url: ex_url, level: level, function: 'ajax'}, function(data){
          if (data['exists']) {
            console.log(data); // check out how data is structured
            $("#ex_dmn_"+id).closest("tr").remove();
          }
          if (data['status']) {
            $.get("/api/crawl/", {task_id: data['task_id'], unique_id: data['unique_id']}, function(mydata){
              alert(mydata.status);
              //$("#ex_url_"+id).html(res['status'])
            });
            $("#ex_url_"+id).html(data['status'])
          }
          })

        .fail(function(xhr){
          console.log(xhr); // check out how data is structured
        });
        return false; 
      }
    $("#start_crawling").click(function(){
         for (var i = 1; i <= counter; i++){
          if (i>23) break;
          startCrawling(i);
        }
    });
    */
</script>
{% endblock %}